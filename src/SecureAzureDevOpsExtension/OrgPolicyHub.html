<!DOCTYPE html>
<html>

<head>
	<link href="Styles/bootstrap.min.css" rel="stylesheet">
	</link>

	<script src="lib/VSS.SDK.min.js"></script>
	<script src="scripts/jquery-3.4.1.min.js"></script>
	<script src="scripts/bootstrap.min.js"></script>

	<script type="text/javascript">

		var context = VSS.getWebContext();
		VSS.init();

		try {
			VSS.ready(() => {
				context = VSS.getWebContext();
			});
		}
		catch (ex) { }

		function delay(ms) { // takes amount of milliseconds
			// returns a new promise
			return new Promise(function (resolve, reject) {
				setTimeout(function () { // when the time is up
					resolve(); // change the promise to the fulfilled state
				}, ms);
			});
		}

		function getDataForChart() {
			// we're RETURNING the promise, remember, a promise is a wrapper over our value
			return delay(1).then(function () { // when the promise is ready	
				return VSS.getService(VSS.ServiceIds.ExtensionData).then(function (dataService) {
					return dataService.getDocument("MyCollection", context.project.name).then(function (doc) {
						return doc.value;
					});
				});
			})
		}


		function getFile() {
			var f = document.getElementById('input-file')
			if (f.files.length > 0) {
				placeFileContent(
					document.getElementById('content-target'),
					f.files[0])
			}
		}

		function placeFileContent(target, file) {
			readFileContent(file).then(content => {
				target.value = content
			}).catch(error => console.log(error))
		}

		function readFileContent(file) {
			const reader = new FileReader()
			return new Promise((resolve, reject) => {
				reader.onload = event => resolve(event.target.result)
				reader.onerror = error => reject(error)
				reader.readAsText(file)
			})
		}

		VSS.notifyLoadSucceeded();

		function Upload() {

			document.getElementById('output').innerHTML = "";
			if (document.getElementById('input-file').files.length > 0) {
				document.getElementById('spnSpinner').style.display = '';
				document.getElementById('spnBtnText').innerHTML = 'Loading...';
				document.getElementById("btnUpload").disabled = true;

				var fileName = document.getElementById('input-file').files[0].name;
				var fileNameWithoutExt = fileName.split('.')[0];
				debugger;
				// we're RETURNING the promise, remember, a promise is a wrapper over our value
				//return delay(1).then(function(){ // when the promise is ready	
				VSS.getService(VSS.ServiceIds.ExtensionData).then(function (dataService) {

					debugger;

					dataService.getDocument("MyCollection").then(
						function (successData) {
							//console.log("data found"+ JSON.stringify(successData));

							var isAzSKjson = successData.value.filter(function (item) {
								return item.id == 'AzSK.json';
							});

							if (isAzSKjson != null && isAzSKjson.length == 0) {
								//create here azsk
								var Azsk = {
									AzSKConfigURL: "https://extmgmt.dev.azure.com/" + context.account.name + "/_apis/ExtensionManagement/InstalledExtensions/ADOScanner/ADOSecurityScanner/Data/Scopes/Default/Current/Collections/MyCollection/Documents?api-version=5.1-preview.1",
									PolicyMessage: "Running AzSK cmdlet using ***" + context.account.name + "*** policy...",
									PolicyOrgName: context.account.name
								};

								var AzskPolicy = { id: 'AzSK.json', Azsk: Azsk };

								dataService.setDocument("MyCollection", AzskPolicy).then(function (doc) {
									console.log("azsk.json policy created");
								});
							}

							var isAzSKSettings = successData.value.filter(function (item) {
								return item.id == 'AzSKSettings.json';
							});

							if (isAzSKSettings != null && isAzSKSettings.length == 0) {
								//create here isAzSKSettings
								var AzSKSettings = {
									UseOnlinePolicyStore: true,
									OnlinePolicyStoreUrl: "https://extmgmt.dev.azure.com/" + context.account.name + "/_apis/ExtensionManagement/InstalledExtensions/ADOScanner/ADOSecurityScanner/Data/Scopes/Default/Current/Collections/MyCollection/Documents{0}?api-version=5.1-preview.1",
									EnableAADAuthForOnlinePolicyStore: false
								};

								var AzSKSettingsPolicy = { id: 'AzSKSettings.json', AzSKSettings: AzSKSettings };

								dataService.setDocument("MyCollection", AzSKSettingsPolicy).then(function (doc) {
									console.log("AzSKSettingsPolicy.json policy created");
								});
							}

							var isServerConfigMetadata = successData.value.filter(function (item) {
								return item.id == 'ServerConfigMetadata.json';
							});

							if (isServerConfigMetadata != null && isServerConfigMetadata.length == 0) {
								var ServerConfigMetadata = {
									OnlinePolicyList: [
										{ Name: 'AzSK.json' },
										{ Name: 'ServerConfigMetadata.json' },
										{ Name: 'AzSKSettings.json' },
										{ Name: fileName }

									]
								};

								var ServerConfigMetadataPolicy = { id: 'ServerConfigMetadata.json', ServerConfigMetadata: ServerConfigMetadata };

								dataService.setDocument("MyCollection", ServerConfigMetadataPolicy).then(function (doc) {
									console.log("ServerConfigMetadata.json policy created");
								});
							}
							else {
								dataService.getDocument("MyCollection", "ServerConfigMetadata.json").then(function (serverconfig) {
									var isFilePresent = serverconfig.ServerConfigMetadata.OnlinePolicyList.filter(function (item) {
										return item.Name == fileName;
									});
									if (isServerConfigMetadata != null && isServerConfigMetadata.length == 0) {
										serverconfig.ServerConfigMetadata.OnlinePolicyList[dataService.ServerConfigMetadata.OnlinePolicyList.length] = { "Name": fileName };
										dataService.setDocument("MyCollection", serverconfig).then(function (doc) {
											console.log(fileName + " added in config.");
										});
									}
									// console.log("ServerConfigMetadata.json policy created"+ JSON.stringify(serverconfig));
								},
									function (err) {
										console.log("ServerConfigMetadata.json get policy error" + JSON.stringify(err));
									}
								);
							}
						},
						function (err) {
							console.log("data not found" + JSON.stringify(err));
						}
					);//coll found end here

					// Prepare document first
					var policycontent = document.getElementById('content-target').value;
					var OrgPolicy = { id: fileName, [fileNameWithoutExt]: policycontent };

					try {
						// Delete document
						dataService.getDocument("MyCollection", OrgPolicy.id).then(
							function (successData) {
								dataService.deleteDocument("MyCollection", OrgPolicy.id).then(function () {
									console.log("Policy deleted");
									dataService.createDocument("MyCollection", OrgPolicy).then(function (doc) {
										console.log("Policy created");
										document.getElementById('output').innerHTML = "Policy created successfully";

										document.getElementById('spnSpinner').style.display = 'none';
										document.getElementById('spnBtnText').innerHTML = 'Upload';
										document.getElementById("btnUpload").disabled = false;

									});
								});
							},
							function (err) {
								dataService.setDocument("MyCollection", OrgPolicy).then(function (doc) {
									console.log("Policy updated");
									document.getElementById('output').innerHTML = "Policy created successfully.";

									document.getElementById('spnSpinner').style.display = 'none';
									document.getElementById('spnBtnText').innerHTML = 'Upload';
									document.getElementById("btnUpload").disabled = false;
								});
							}

						);
					}
					catch (ex) {
						console.log(ex);
					}
				});
			}
			else {
				alert('Please select a file to upload.');
			}
		}
	</script>
</head>

<body style="width: 100%; height: 100%; margin-left: 10px; margin-top: 10px;">
	<div class="row">
		<div class="col-sm-11">
			<div class="card" style="align-items: left;">
				<div class="card-header" style="text-align: left;">
					<strong>
						<h2> Org Policy</h2>
					</strong>
					Scan command from the AzSK relies on JSON-based policy files to determine various parameters that
					effect the behavior of the command it is about to run.
				</div>
				<div class="card-body">
					<div>
						<input type="file" id="input-file"><br> <br>
						<input type="submit" onclick="getFile()" value="Get Content" class="btn btn-primary">
					</div>
					<br>
					<textarea id="content-target" style="min-width:800px; min-height: 300px;"></textarea>
					<br>

					<button id="btnUpload" class="btn btn-primary" onclick="Upload()">
						<span id="spnSpinner" style="display:none" class="spinner-border spinner-border-sm"></span>
						<span id="spnBtnText">Upload</span>
					</button>
					<br>
					<span style="color:green" id="output"></span>
				</div>
			</div>
		</div>
	</div>
</body>

</html>