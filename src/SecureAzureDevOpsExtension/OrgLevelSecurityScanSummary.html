<!DOCTYPE html>
<html>

<head>
	<link href="Styles/bootstrap.min.css" rel="stylesheet">
	</link>
	<style>
		.btn-circle {
			width: 12px;
			height: 12px;
			line-height: 12px;
			text-align: center;
			padding: 0;
			border-radius: 50%;
		}

		.btn-circle i {
			position: relative;
			top: -1px;
		}

		.btn-circle-sm {
			width: 8px;
			height: 8px;
		}

		.text-primary {
			color: #305f92 !important;
		}

		.bubble-manual {
			background-color: #6c757d;
		}

		.bubble-passed {
			background-color: #339947;
		}

		.bubble-failed {
			background-color: #FF0000;
		}

		.bubble-verify {
			background-color: #F58B1F;
		}

		.shadow {
			-webkit-box-shadow: 0 10px 6px -6px #999;
			-moz-box-shadow: 0 10px 6px -6px #999;
			box-shadow: 0 10px 6px -12px #999;
		}
	</style>
	</style>
	<script src="lib/VSS.SDK.min.js"></script>
	<script src="scripts/jquery-3.4.1.min.js"></script>
	<script src="scripts/bootstrap.min.js"></script>

	<script type="text/javascript">
		var arrdata = { Passed: 0, Failed: 0, Verify: 0 };
		var Prjarrdata = { Passed: 0, Failed: 0, Verify: 0 };
		//var Usrarrdata = { Passed: 0, Failed: 0, Verify: 0 };

		var context = VSS.getWebContext();
		VSS.init({
			explicitNotifyLoaded: true,
			usePlatformStyles: true
		});

		try {
			VSS.ready(() => {
				context = VSS.getWebContext();
			});
		}
		catch (ex) { }

		//setuserData();
		//getuserData();
		function openModel(Description, ControlID, ResourceGroupName, ResourceName, Status, Recommendation) {

			try {
				$('#spnFailedControl').html(ControlID);
				$('#spnDescription').html(Description);
				$('#spnResourceName').html(ResourceName);
				$('#spnResourceGroupName').html(ResourceGroupName);
				$('#spnStatus').html(Status);
				$('#spnRecommendation').html(Recommendation);

				$('#btnSendNotification').focus()
			}
			catch (ex) { console.log(ex); }
		}


		function delay(ms) { // takes amount of milliseconds
			// returns a new promise
			return new Promise(function (resolve, reject) {
				setTimeout(function () { // when the time is up
					resolve(); // change the promise to the fulfilled state
				}, ms);
			});
		}

		var data;
		function getDataForChart(resultId) {
			debugger;
			console.log(resultId);
			// we're RETURNING the promise, remember, a promise is a wrapper over our value
			return delay(1).then(function () { // when the promise is ready	context.project.name
				return VSS.getService(VSS.ServiceIds.ExtensionData).then(function (dataService) {
					if (resultId == null || resultId == "") {
						return dataService.getDocument("MyCollection").then(function (doc) {

							var result = doc.value.filter(function (item) {
								return item.id.includes(context.project.name + '_BuilbId');
							});
							data = result;
							return result[result.length - 1].value;
						});
					}
					else {
						return dataService.getDocument("MyCollection", resultId).then(function (doc) {
							return doc.value;
						});
					}
				});
			})
		}
		// Get data service
		VSS.getService(VSS.ServiceIds.ExtensionData).then(function (dataService) {
			// Get all document under the collection

			dataService.getDocuments("MyCollection").then(function (docs) {
				var sel = document.getElementById('resultVersion');
				for (var i = 0; i < docs.length; i++) {
					if (docs[i].id.indexOf(context.project.name) !== -1) {
						var opt = document.createElement('option');
						opt.innerHTML = docs[i].id;
						opt.value = docs[i].id;
						sel.appendChild(opt);
					}
				}
				docs = null;
			});
		});
		//function setuserData(){
		//	debugger;
		//	try{
		//VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
		//        // Set value in user scope
		//        dataService.setValue("userScopedKey", 12345, {scopeType: "User"}).then(function(value) {
		//            console.log("User scoped key value is " + value);
		//        });
		//    });
		//	}
		//	catch (ex) {
		//		console.log("exception " + ex);
		//	}
		//}

		//function getuserData(){
		//	debugger;
		//	// Get data service
		//	try{
		//    VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
		//        // Get value in user scope
		//        dataService.getValue("userScopedKey", {scopeType: "User"}).then(function(value) {
		//            console.log("User scoped key value is " + value);
		//        });
		//    });
		//  }
		//	catch (ex) {
		//		console.log("exception " + ex);
		//	}
		//}

		var versions = document.getElementById('resultVersion')
		versionId = "";
		if (versions != null) {
			versionId = versions.value;
		}
		VSS.require(["TFS/Dashboards/WidgetHelpers", "Charts/Services"], function (WidgetHelpers, Services) {
			WidgetHelpers.IncludeWidgetStyles();
			WidgetHelpers.IncludeWidgetConfigurationStyles();

			VSS.register("OrgLevelSecurityScanSummary", function () {
				return {
					load: function () {
						return Services.ChartsService.getService().then(function (chartService) {
							debugger;
							getDataForChart(versionId).then(function (chartdata) {

								// var spanid='spn';
								chartdata.forEach(function (e) {
									var bulbClass = 'bubble-manual';
									if (e.FeatureName == "Organization") {
										if (e.Status == "Passed") {
											arrdata.Passed = arrdata.Passed + 1;
											bulbClass = 'bubble-passed';
										}
										if (e.Status == "Failed") {
											arrdata.Failed = arrdata.Failed + 1;
											bulbClass = 'bubble-failed';
										}
										if (e.Status == "Verify") {
											arrdata.Verify = arrdata.Verify + 1;
											bulbClass = 'bubble-verify';
										}

										$('#tblScanResultOrganizaiton').find('tbody')
											.append('<tr>').append('<td width="40%"><span class="text-primary" >' + e.Description + '</span></td>')
											//a href="#" onclick = "openModel(\''+e.Description+'\',\''+e.ControlID+'\',\''+e.ResourceGroupName+'\',\''+e.ResourceName+'\',\''+e.Status+'\',\''+e.Recommendation+'\')" data-toggle="modal" data-target="#myModal"
											.append('<td width="20%" >' + e.ControlSeverity + '</td>')
											.append('<td width="20%" > <span class="btn ' + bulbClass + ' btn-circle btn-circle-sm"></span>&nbsp;' + e.Status + '</td>')
											.append('<td width="20%" > <a href=' + e.ResourceLink + ' target="_blank">Click to find resource</a></td>')
											.append('</tr>');
									}

									if (e.FeatureName == "Project") {
										//var bulbClass='';
										if (e.Status == "Passed") {
											Prjarrdata.Passed = Prjarrdata.Passed + 1;
											bulbClass = 'bubble-passed';
										}
										if (e.Status == "Failed") {
											Prjarrdata.Failed = Prjarrdata.Failed + 1;
											bulbClass = 'bubble-failed';
										}
										if (e.Status == "Verify") {
											Prjarrdata.Verify = Prjarrdata.Verify + 1;
											bulbClass = 'bubble-verify';
										}
										$('#tblScanResultProject').find('tbody')
											.append('<tr>').append('<td width="40%" ><span class="text-primary">' + e.Description + '</span></td>')
											.append('<td width="20%" >' + e.ControlSeverity + '</td>')
											.append('<td width="20%" >' + e.ResourceName + '</td>')
											.append('<td width="20%" > <span class="btn ' + bulbClass + ' btn-circle btn-circle-sm"></span>&nbsp;' + e.Status + '</td>')
											.append('<td width="20%" > <a href=' + e.ResourceLink + ' target="_blank">Click to find resource</a></td>')
											.append('</tr>');
									}
								});

								var $container = $('#Chart-ContainerOrganizaiton');
								var chartOptions = {
									"hostOptions": {
										"height": "220",
										"width": "300"
									},
									"chartType": "pie",
									"series": [{
										"data": Object.values(arrdata)
									}],
									"xAxis": {
										"labelValues": ["Passed", "Failed", "Verify"]
									},
									"colorCustomizationOptions": {
										"customColors": [
											{ backgroundColor: "#339947", value: "Passed" },//#FF0000
											{ backgroundColor: "#FF0000", value: "Failed" },
											{ backgroundColor: "#F58B1F", value: "Verify" }
										]
									},
									"specializedOptions": {
										"showLabels": "true",
										"size": 175
									}
								};

								chartService.createChart($container, chartOptions);

								var $containerPrj = $('#Chart-ContainerProject');

								var chartOptionsPrj = {
									"hostOptions": {
										"height": "220",
										"width": "300"
									},
									"chartType": "pie",
									"series": [{
										"data": Object.values(Prjarrdata)
									}],
									"xAxis": {
										"labelValues": ["Passed", "Failed", "Verify"]
									},
									"colorCustomizationOptions": {
										"customColors": [
											{ backgroundColor: "#339947", value: "Passed" },//#FF0000
											{ backgroundColor: "#FF0000", value: "Failed" },
											{ backgroundColor: "#F58B1F", value: "Verify" }
										]
									},
									"specializedOptions": {
										"showLabels": "true",
										"size": 175
									}
								};

								chartService.createChart($containerPrj, chartOptionsPrj);
								return WidgetHelpers.WidgetStatusHelper.Success();
							});

						});
					}
				}
			});
			VSS.notifyLoadSucceeded();
		});


		function bindData() {
			debugger;
			console.log('xyz');
			var versionId = document.getElementById('resultVersion').value;
			console.log('xyz2');
			if (versionId != null && versionId != "") {
				try {
					console.log('xyz3');

					//bind table with new data
					debugger;
					bindTables(data.filter(function (item) { return item.id == versionId }));

					VSS.require(["Charts/Services"], function (Services) {
						console.log('xyz3');
						return {
							load: function () {
								return Services.ChartsService.getService().then(function (chartService) {
									console.log('xyz4');
									var $container = $('#Chart-ContainerOrganizaiton');
									var chartOptions = {
										"hostOptions": {
											"height": "220",
											"width": "300"
										},
										"chartType": "pie",
										"series": [{
											"data": [1, 2, 4]
										}],
										"xAxis": {
											"labelValues": ["Passed", "Failed", "Verify"]
										},
										"colorCustomizationOptions": {
											"customColors": [
												{ backgroundColor: "#339947", value: "Passed" },//#FF0000
												{ backgroundColor: "#FF0000", value: "Failed" },
												{ backgroundColor: "#F58B1F", value: "Verify" }
											]
										},
										"specializedOptions": {
											"showLabels": "true",
											"size": 175
										}
									};

									chartService.createChart($container, chartOptions);
								});
							}
						}
					});
				}
				catch (ex) {
					console.log(ex)
				}
			}
		}


		function bindTables(chartdata) {
			$("#tblScanResultOrganizaiton > tbody").html("");
			$("#tblScanResultProject > tbody").html("");

			chartdata[0].value.forEach(function (e) {
				var bulbClass = 'bubble-manual';
				if (e.FeatureName == "Organization") {
					if (e.Status == "Passed") {
						arrdata.Passed = arrdata.Passed + 1;
						bulbClass = 'bubble-passed';
					}
					if (e.Status == "Failed") {
						arrdata.Failed = arrdata.Failed + 1;
						bulbClass = 'bubble-failed';
					}
					if (e.Status == "Verify") {
						arrdata.Verify = arrdata.Verify + 1;
						bulbClass = 'bubble-verify';
					}

					$('#tblScanResultOrganizaiton').find('tbody')
						.append('<tr>').append('<td width="40%"><span class="text-primary" >' + e.Description + '</span></td>')
						//a href="#" onclick = "openModel(\''+e.Description+'\',\''+e.ControlID+'\',\''+e.ResourceGroupName+'\',\''+e.ResourceName+'\',\''+e.Status+'\',\''+e.Recommendation+'\')" data-toggle="modal" data-target="#myModal"
						.append('<td width="20%" >' + e.ControlSeverity + '</td>')
						.append('<td width="20%" > <span class="btn ' + bulbClass + ' btn-circle btn-circle-sm"></span>&nbsp;' + e.Status + '</td>')
						.append('<td width="20%" > <a href=' + e.ResourceLink + ' target="_blank">Click to find resource</a></td>')
						.append('</tr>');
				}

				if (e.FeatureName == "Project") {
					//var bulbClass='';
					if (e.Status == "Passed") {
						Prjarrdata.Passed = Prjarrdata.Passed + 1;
						bulbClass = 'bubble-passed';
					}
					if (e.Status == "Failed") {
						Prjarrdata.Failed = Prjarrdata.Failed + 1;
						bulbClass = 'bubble-failed';
					}
					if (e.Status == "Verify") {
						Prjarrdata.Verify = Prjarrdata.Verify + 1;
						bulbClass = 'bubble-verify';
					}
					$('#tblScanResultProject').find('tbody')
						.append('<tr>').append('<td width="40%" ><span class="text-primary">' + e.Description + '</span></td>')
						.append('<td width="20%" >' + e.ControlSeverity + '</td>')
						.append('<td width="20%" >' + e.ResourceName + '</td>')
						.append('<td width="20%" > <span class="btn ' + bulbClass + ' btn-circle btn-circle-sm"></span>&nbsp;' + e.Status + '</td>')
						.append('<td width="20%" > <a href=' + e.ResourceLink + ' target="_blank">Click to find resource</a></td>')
						.append('</tr>');
				}
			});
		}

	</script>
</head>

<body style="width: 100%; height: 100%;">
	<div>
		<!-- style="overflow-y: scroll; overflow-x: hidden;" -->
		<div class="row">
			<div class="col-sm-11">
				<div class="card" align="left" style="align-items: left;">
					<div class="card-header" style="text-align: left;">
						<strong>
							<h2> ADO Security Scanner Scan Summary for Organization and Project.</h2>
						</strong>
						<a href="http://aka.ms/devopskit/ADOSecurity">ADO security scanner Kit</a>
					</div>
					<div class="card-body">
						The "ADO security scanner Kit" is a collection of scripts, tools, extensions, automations, etc.
						that caters to the end to end Azure DevOps resources security needs for dev ops
						teams using extensive automation and smoothly integrating security into native
						workflows helping accomplish secure dev ops..
						<div class="row">
							<div class="col-sm-4">Select Version : </div>
							<div class="col-sm-4">
								<select id="resultVersion" class="form-control" onchange="bindData()" width="300px">
									<option value="" width="300px">Select</option>
								</select>
							</div>
						</div>

					</div>
				</div><!-- /# card -->
			</div>
		</div>

		<div class="row" style="margin-top: 0.2em; padding: 0.2em;">
			<div class="col-sm-4">
				<!--/.col-->
				<div class="card">
					<div class="card-body" style="padding: 4px;">
						<!-- <div class="chart-wrapper">	 -->
						<h4 class="card-title">Organization Scan Result </h4>
						<div id="Chart-ContainerOrganizaiton" style="padding:0px;margin:0px"></div>
						<!-- 	</div> -->
					</div>
				</div>
			</div>
			<div class="col-sm-7" style="overflow:scroll;height:220px;width:100%;overflow:auto">
				<div class="media-body">
					<h2 class="text-blue">Organization Scan Report </h2>
					<table id="tblScanResultOrganizaiton" class="table table-borderless table-sm">
						<thead style="border-bottom:solid; border-width: 1px;">
							<tr>
								<th width="40%">Description</th>
								<th width="20%">Severity</th>
								<th width="20%">Status</th>
								<th width="20%">Resource</th>
							</tr>
						</thead>
						<tbody class="table table-borderless">
							<!-- 	<tr>
														<td width="40%" ><a href="#" onclick = "openModel('e')" data-toggle="modal" data-target="#myModal">descr</a></td>
														 <td width="20%" ></td>
														 <td width="20%" ></td>
														 <td width="20%" ></td>
												</tr>	 -->
						</tbody>
					</table>
				</div>
			</div>

			<!-- To change the direction of the modal animation change .right class -->
			<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
				aria-hidden="true">

				<!-- Add class .modal-side and then add class .modal-top-right (or other classes from list above) to set a position to the modal -->
				<div class="modal-dialog modal-lg modal-side modal-top-right" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h2 class="modal-title w-100" id="myModalLabel">Details for <span id="spnFailedControl">
								</span></h2>
							<button type="button" id="btnSendNotification" class="btn btn-primary"
								style="height:38px;">Send Notification</button>
							<!--  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button> -->
						</div>
						<div class="modal-body" style="overflow:scroll;max-height:350px;width:100%;overflow:auto">
							<div class="card-body shadow">Description: <span id="spnDescription"> </span> </div>
							<div class="card-body shadow">Resource Name: <span id="spnResourceName"> </span> </div>
							<div class="card-body shadow">Resource Group Name: <span id="spnResourceGroupName"> </span>
							</div>
							<div class="card-body shadow">Status: <span id="spnStatus"> </span> </div>
							<div class="card-body shadow">Recommendation: <span id="spnRecommendation"> </span> </div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal" style="height:38px;">
								Close</button>
						</div>
					</div>
				</div>
			</div>
			<!-- Side Modal Top Right -->

		</div>

		<div class="row" style="margin-top: 0.2em; padding: 0.2em;">
			<div class="col-sm-4">
				<!--/.col-->
				<div class="card">
					<div class="card-body" style="padding: 4px;">
						<!-- <div class="chart-wrapper">	 -->
						<h4 class="card-title">Project Scan Result </h4>
						<div id="Chart-ContainerProject" style="padding:0px;margin:0px"></div>
						<!-- 	</div> -->
					</div>
				</div>
			</div>
			<div class="col-sm-7" style="overflow:scroll;height:220px;width:100%;overflow:auto">
				<div class="media-body">
					<h2 class="text-blue" style="margin-bottom: 5px;">Project Scan Report</h2>
					<table id="tblScanResultProject" class="table table-borderless table-sm">
						<thead style="border-bottom:solid; border-width: 1px;">
							<tr>
								<th width="40%">Description</th>
								<th width="20%">Severity</th>
								<th width="20%">Resource Name</th>
								<th width="20%">Status</th>
								<th width="20%">Resource </th>
							</tr>
						</thead>
						<tbody class="table table-borderless">
							<!-- <tr>
														<td width="40%" ></td>
														 <td width="20%" ></td>
														 <td width="20%" ></td>
														 <td width="20%" ></td>
												</tr> -->
						</tbody>
					</table>
				</div>
			</div>
		</div>


	</div>

</body>

</html>